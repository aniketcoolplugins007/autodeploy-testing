name: Plugin Quality Check & Conditional Deploy

on:
  push:
    branches:
      - "**"   # runs only when you push a tag

permissions:
  contents: write  # required to delete remote tags

jobs:
  plugin-check:
    name: Run Plugin Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run WordPress Plugin Check
        id: check
        uses: wordpress/plugin-check-action@v1
        with:
          build-dir: './'
          exclude-directories: |
            vendor
            third-party
            node_modules
          categories: |
            plugin_repo
            security
          strict: true

      - name: Summary (success)
        if: success()
        run: echo "‚úÖ Plugin Check passed."

      - name: Send Plugin Check Log via Email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: "jebk dviy mqds jocv"
          to: vishabjeetcoolplugins@gmail.com
          from: CoolPlugins CI Bot <${{ secrets.MAIL_USERNAME }}>
          subject: "‚ùå Plugin Check Failed for ${{ inputs.plugin-folder }} Because PCP errors found."
          html_body: |
            üëã <strong>Hello CoolPlugins Team,</strong>
            <br>
            <br>
            The <strong>PCP</strong> for plugin <strong>`${{ inputs.plugin-folder }}`</strong> has <strong>failed</strong> Because of errors found. Please fix the errors and try again.
            <br>
            <h2>üìã Summary</h2>
            - <strong>Repository:</strong> `${{ github.repository }}`
            <br>
            - <strong>Workflow Run:</strong> [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            <br>
            - <strong>Checked Folder:</strong> `${{ inputs.plugin-folder }}`
            <br>
            <br>
            <h2>‚ö†Ô∏è Detected Issues / Errors</h2>
            <br>
            <code>
              <pre style="background:#f6f8fa;padding:12px;border-radius:8px;font-family:'Courier New',monospace;font-size:15px;white-space:pre-wrap;line-height:1.5;">
                ${{ steps.read_log.outputs.log_content }}
              </pre>
            </code>
            <br>
            Best regards, <br>
            ‚Äî <strong>üß† CoolPlugins CI Bot</strong>
