name: Plugin Quality Check & Conditional Deploy

on:
  push:
    branches:
      - "**"   # runs only when you push a tag

permissions:
  contents: write  # required to delete remote tags

jobs:
  plugin-check:
    name: Run Plugin Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run WordPress Plugin Check
        id: check
        uses: wordpress/plugin-check-action@v1
        with:
          build-dir: './'
          exclude-directories: |
            vendor
            third-party
            node_modules
          categories: |
            plugin_repo
            security
          strict: true

      - name: Summary (success)
        if: success()
        run: echo "‚úÖ Plugin Check passed."

      - name: ‚öôÔ∏è Generate HTML Report File
        id: generate_html_file
        # Run only if the plugin check failed and produced the results file
        if: steps.check.outcome == 'failure'
        run: |
          RESULT_FILE="/home/runner/work/_temp/plugin-check-results.txt"
          TEMP_JSON_FILE="$RUNNER_TEMP/plugin-check-results.json"
          HTML_OUTPUT_FILE="$RUNNER_TEMP/plugin-check-html.txt" # Target output file

          # --- 1. Check for the results file ---
          if [ ! -f "$RESULT_FILE" ]; then
            echo "‚ùå Plugin check result file not found! Skipping HTML generation."
            exit 0
          fi
          
          # --- 2. Convert TXT content to JSON file ---
          # The TXT file contains raw JSON output from the action. We save it to a .json file.
          cat "$RESULT_FILE" > "$TEMP_JSON_FILE"
          
          # --- 3. Count Totals (for Summary) ---
          ERROR_COUNT=$(jq '[.[] | select(.type=="ERROR")] | length' "$TEMP_JSON_FILE")
          WARNING_COUNT=$(jq '[.[] | select(.type=="WARNING")] | length' "$TEMP_JSON_FILE")

          # --- 4. Generate Full HTML Structure and Save to $HTML_OUTPUT_FILE ---
          {
            # HTML Header and Summary
            echo "<!DOCTYPE html>"
            echo "<html><body style='font-family:Arial,sans-serif;font-size:14px;'>"
            echo "üëã <strong>Hello CoolPlugins Team,</strong><br><br>"
            echo "The <strong>Plugin Check</strong> for plugin <strong>${{ inputs.plugin-folder }}</strong> has <strong>failed</strong> because of detected issues.<br><br>"
            
            echo "<h2>üìã Summary</h2>"
            echo "<ul>"
            echo "<li><strong>Repository:</strong> <code>${{ github.repository }}</code></li>"
            echo "<li><strong>Workflow Run:</strong> <a href='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'>View Logs</a></li>"
            echo "<li><strong>Checked Folder:</strong> <code>${{ inputs.plugin-folder }}</code></li>"
            echo "<li><strong>Detected:</strong> üö® ${ERROR_COUNT} Errors | ‚ö†Ô∏è ${WARNING_COUNT} Warnings</li>"
            echo "</ul><br>"
            
            # HTML Table Header
            echo "<h2>‚ö†Ô∏è Detected Issues / Errors</h2>"
            echo "<table border='1' cellspacing='0' cellpadding='8' style='border-collapse:collapse;font-family:Arial,sans-serif;font-size:13px;width:100%;'>"
            echo "<thead style='background:#f6f8fa;'><tr><th>Type</th><th>Code</th><th>Message</th><th>Docs</th></tr></thead><tbody>"
            
            # --- 5. Generate Table Rows using jq (The "Loop") ---
            # jq processes the JSON array and converts each object into a table row <tr>
            jq -r '
              .[] |
              "<tr>" +
                "<td style=\"color:" + (if .type=="ERROR" then "red" else "#e6b800" end) + ";font-weight:bold;\">" + .type + "</td>" +
                "<td><code>" + .code + "</code></td>" +
                "<td>" + (.message | gsub("\\|";"\\|")) + "</td>" +
                "<td>" + (if (.docs|length)>0 then "<a href=\"" + .docs + "\">Docs</a>" else "‚Äî" end) + "</td>" +
              "</tr>"
            ' "$TEMP_JSON_FILE"
            
            # HTML Footer
            echo "</tbody></table><br>"
            echo "Best regards,<br><strong>üß† CoolPlugins CI Bot</strong>"
            echo "</body></html>"
          } > "$HTML_OUTPUT_FILE" # Save all output to the new file

          # --- 6. Set Output Variable to make the FILE PATH accessible ---
          # We export the PATH to the generated HTML file, not the content itself.
          echo "html_file_path=$HTML_OUTPUT_FILE" >> $GITHUB_OUTPUT

      - name: Testing Output
        run: |
          echo "html_body: ${{ steps.email_body }}"
          echo "html_body: ${{ steps.email_body.outputs }}"
          echo "html_body: ${{ steps.email_body.outputs.html_body }}"

