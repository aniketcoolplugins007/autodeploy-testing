name: Plugin Quality Check & Conditional Deploy

on:
  push:
    branches:
      - "**"   # runs only when you push a tag

permissions:
  contents: write  # required to delete remote tags

jobs:
  plugin-check:
    name: Run Plugin Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run WordPress Plugin Check
        id: check
        uses: wordpress/plugin-check-action@v1
        with:
          build-dir: './'
          exclude-directories: |
            vendor
            third-party
            node_modules
          categories: |
            plugin_repo
            security
          strict: true

      - name: Summary (success)
        if: success()
        run: echo "‚úÖ Plugin Check passed."

      - name: Generate HTML Email Body
        id: email_body
        run: |
          {
            echo "üëã <strong>Hello CoolPlugins Team,</strong><br><br>"
            echo "The <strong>Plugin Check</strong> for plugin <strong>${{ inputs.plugin-folder }}</strong> has <strong>failed</strong> because of detected issues.<br><br>"
            echo "<h2>üìã Summary</h2>"
            echo "<ul>"
            echo "<li><strong>Repository:</strong> <code>${{ github.repository }}</code></li>"
            echo "<li><strong>Workflow Run:</strong> <a href='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'>View Logs</a></li>"
            echo "<li><strong>Checked Folder:</strong> <code>${{ inputs.plugin-folder }}</code></li>"
            echo "</ul><br>"
            echo "<h2>‚ö†Ô∏è Detected Issues / Errors</h2>"
            echo "<table border='1' cellspacing='0' cellpadding='8' style='border-collapse:collapse;font-family:Arial,sans-serif;font-size:14px;'>"
            echo "<thead><tr style='background:#f6f8fa'><th>Type</th><th>Code</th><th>Message</th><th>Docs</th></tr></thead><tbody>"
            jq -r '.[] | "<tr><td>" + .type + "</td><td>" + .code + "</td><td>" + (.message | gsub("\\|";"\\|")) + "</td><td><a href=\"" + .docs + "\">Docs</a></td></tr>"' $RUNNER_TEMP/plugin-check-results.json
            echo "</tbody></table><br>"
            echo "Best regards,<br><strong>üß† CoolPlugins CI Bot</strong>"
          } > email-body.html

      - name: Send Plugin Check Log via Email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: "jebk dviy mqds jocv"
          to: vishabjeetcoolplugins@gmail.com
          from: CoolPlugins CI Bot <${{ secrets.MAIL_USERNAME }}>
          subject: "‚ùå Plugin Check Failed for ${{ inputs.plugin-folder }} Because PCP errors found."
          html_body: |
            ${{ steps.email_body.outputs.html_body }}
